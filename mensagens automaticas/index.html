<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Enviar no WhatsApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
<style>
    :root {
        --verde-whatsapp: #25D366;
        --verde-escuro: #128C7E;
        --fundo-claro: #ffffff;
        --texto-claro: #000000;
        --fundo-escuro: #1e1e1e;
        --texto-escuro: #ffffff;
    }
    body {
        font-family: Arial, sans-serif;
        background-color: var(--fundo-claro);
        color: var(--texto-claro);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
        transition: background 0.3s, color 0.3s;
    }
    body.dark {
        background-color: var(--fundo-escuro);
        color: var(--texto-escuro);
    }
    .container {
        background: rgba(255,255,255,0.9);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        width: 370px;
        transition: background 0.3s;
    }
    body.dark .container {
        background: rgba(34,34,34,0.9);
    }
    h2 {
        margin-bottom: 15px;
        text-align: center;
    }
    input, textarea {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        outline: none;
    }
    input:focus, textarea:focus {
        border-color: var(--verde-whatsapp);
    }
    button {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        margin: 2px;
    }
    .btn-enviar {
        width: 100%;
        padding: 12px;
        font-weight: bold;
        background: var(--verde-whatsapp);
        color: white;
    }
    .btn-enviar:hover {
        background: var(--verde-escuro);
    }
    .btn-editar {
        background: orange;
        color: white;
    }
    .btn-excluir {
        background: red;
        color: white;
    }
    .btn-nota {
        background: #555;
        color: white;
    }
    .btn-nome {
        background: blue;
        color: white;
    }
    .tema-toggle {
        background: none;
        border: none;
        cursor: pointer;
        margin-bottom: 15px;
        font-size: 14px;
        color: var(--verde-whatsapp);
        font-weight: bold;
    }
    .historico {
        margin-top: 20px;
    }
    .msg-item {
        background: var(--verde-whatsapp);
        color: white;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        font-size: 14px;
    }
    body.dark .msg-item {
        background: var(--verde-escuro);
    }
    .nota {
        font-size: 12px;
        font-style: italic;
        margin-top: 5px;
        opacity: 0.8;
    }
    .nome {
        font-weight: bold;
    }
</style>
</head>
<body>
<div class="container">
    <button class="tema-toggle" onclick="alternarTema()">üåô Mudar Tema</button>
    <h2>Enviar no WhatsApp</h2>
    <input type="tel" id="numero" placeholder="Ex: 11987654321" maxlength="13">
    <textarea id="mensagem" placeholder="Digite sua mensagem"></textarea>
    <button class="btn-enviar" onclick="enviarMensagem()">üì© Enviar</button>
    <div class="historico" id="historico"></div>
</div>

<script>
let db;

async function initDB() {
    const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
    let savedDb = localStorage.getItem("whatsappDB");
    if (savedDb) {
        db = new SQL.Database(Uint8Array.from(atob(savedDb), c => c.charCodeAt(0)));
    } else {
        db = new SQL.Database();
        db.run(`CREATE TABLE historico (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            numero TEXT, 
            mensagem TEXT, 
            nome TEXT, 
            nota TEXT, 
            data TEXT
        )`);
    }
    mostrarHistorico();
}

function salvarDB() {
    const data = btoa(String.fromCharCode(...db.export()));
    localStorage.setItem("whatsappDB", data);
}

function enviarMensagem() {
    let numero = document.getElementById("numero").value.replace(/\D/g, '');
    let mensagem = document.getElementById("mensagem").value.trim();

    if (!/^\d{2}\d{9}$/.test(numero)) {
        alert("Digite um n√∫mero v√°lido no formato brasileiro: DDD + 9 d√≠gitos. Ex: 11987654321");
        return;
    }

    let numeroCompleto = "55" + numero;
    let url = `https://wa.me/${numeroCompleto}?text=${encodeURIComponent(mensagem)}`;
    window.open(url, '_blank');

    db.run(`INSERT INTO historico (numero, mensagem, nome, nota, data) VALUES (?, ?, '', '', ?)`, 
        [numeroCompleto, mensagem, new Date().toLocaleString()]);
    salvarDB();
    mostrarHistorico();

    document.getElementById("numero").value = "";
    document.getElementById("mensagem").value = "";
}

function mostrarHistorico() {
    let lista = document.getElementById("historico");
    lista.innerHTML = "";
    const stmt = db.prepare("SELECT * FROM historico ORDER BY id DESC");
    while (stmt.step()) {
        let item = stmt.getAsObject();
        lista.innerHTML += `
            <div class="msg-item">
                ${item.nome ? `<div class="nome">üë§ ${item.nome}</div>` : ""}
                <b>${item.numero}</b><br>${item.mensagem}
                ${item.nota ? `<div class="nota">üìù ${item.nota}</div>` : ""}
                <br><small>${item.data}</small><br>
                <button class="btn-nome" onclick="editarNome(${item.id})">üë§ Nome</button>
                <button class="btn-nota" onclick="editarNota(${item.id})">üìù Nota</button>
                <button class="btn-excluir" onclick="excluirRegistro(${item.id})">üóë Excluir</button>
            </div>
        `;
    }
    stmt.free();
}

function editarNome(id) {
    let novoNome = prompt("Digite o nome:");
    if (novoNome !== null) {
        db.run(`UPDATE historico SET nome = ? WHERE id = ?`, [novoNome.trim(), id]);
        salvarDB();
        mostrarHistorico();
    }
}

function editarNota(id) {
    let novaNota = prompt("Digite a nota:");
    if (novaNota !== null) {
        db.run(`UPDATE historico SET nota = ? WHERE id = ?`, [novaNota.trim(), id]);
        salvarDB();
        mostrarHistorico();
    }
}

function excluirRegistro(id) {
    if (confirm("Tem certeza que deseja excluir este registro?")) {
        db.run(`DELETE FROM historico WHERE id = ?`, [id]);
        salvarDB();
        mostrarHistorico();
    }
}

function alternarTema() {
    document.body.classList.toggle("dark");
}

initDB();
</script>
</body>
</html>
